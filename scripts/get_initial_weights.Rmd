---
title: "Plot Weights & Locations"
author: 
output: 
  pdf_document: default
  word_document: default
header-includes:
- \usepackage{float}
- \usepackage[width=\textwidth]{caption}
- \usepackage{wrapfig}
always_allow_html: yes
csl: ../citations/citations/apa.csl
bibliography: ../citations/citations/citations.bib
link-citations: yes
---

\pagenumbering{gobble}
\vspace{-1cm}

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F)
knitr::opts_chunk$set(dpi = 300) 
knitr::opts_chunk$set(message = F)
knitr::opts_chunk$set(warning = F)
knitr::opts_chunk$set(fig.pos = 'H')
```

```{r Load libraries, warning = F, message = F, echo = F}
library(tidyverse)
library(sf)
library(terra)
library(spsurvey)
library(kableExtra)
library(ggalluvial)
source('functions.R')
```

```{r introduction writing materials}
p2drought <- '../../drought_geospatial'
dem <- rast(
  file.path(p2drought, 'dem/EarthEnv-DEM90_N35W110/EarthEnv-DEM90_N35W110.bil'))

spatial_products <- '../../UFO_cartography'
elevations <- st_read(file.path(spatial_products, 
                         'BLM_CO_Grazing_Allotments/gra_allot_poly.shp'), quiet = T) %>% 
  vect() %>% 
  project(crs(dem)) %>% 
  extract(dem, .)

min_el <- min(elevations$`EarthEnv-DEM90_N35W110`) * 3.28084
max_el <- max(elevations$`EarthEnv-DEM90_N35W110`) * 3.28084

rm(p2drought, dem, elevations)
```

This AIM study was designed with three major principals in mind. The first, was maximizing the number of environments which it represents across the field office. The UFO field office varies by nearly `r round(max_el - min_el, -2)` feet, and displays a diversity of environments associated with this topographic gradient; and this sample design included this entire range of variation. To ensure that these diverse areas were represented, ten major strata were identified (Table 1), in order to ensure that they had plots located in them in order to evaluate their ecological *integrity*. However, the management concerns, actions, and heterogeneity (internal dissimilarity) of these strata differ. To best understand the ecological context of these strata, and what management actions the BLM may take, the proportion of plots were tailored to each stratum. The third principal was that all plots be randomly placed within the stratum, which allows *inference* to be made from plots to the, unsampled, entirety of the stratum. This *weighted sample design* allows us to maximize statistical understanding while minimizing the field effort required to undertake it. Finally, the entire field office was designated as the *sample frame*, i.e. the area of analysis (or a spatially explicit population), which statistical inference can be made to.

The initial sample design followed the general AIM implementation design to contain 255 plots to be sampled across five years. Sampling over a five year period is essential in order to ensure that plots are visited during periods wherein the vegetation is a state of *reproductive activity*, hence identifiable. A benefit of this prolonged time frame is that anomalous weather conditions are unlikely to affect the plots across the entire time period. For example, the condition of plots may be compared in a wet year, to a dry year, as referenced from a year with typical rainfall. In order to avoid random unexpected processes which cluster in space which may occur over the period of conducting the sample design, the entire design is split into a part of the year when plants are reproductively active for each year of sampling. Each panel is composed of a subset of randomly selected points within the sample design and avoids missing swathes of the *target frame* during the sample period due to an event such as a prolonged wildfire. 

The location of the random plots for AIM are generated via computer and a number of them may not feasibly be sampled. In general potential plots are most often, anecdotally, rejected for: being located on steep slopes which are dangerous for field crews to sample, requiring access to cross private land to access BLM which landowners deny. The inability of these plots to be sampled reduces the spatial extent of the strata which we may use statistics to infer across, and increases the measures of uncertainty associated with these areas. In this section we review the original sample design, derive original sample weights for sub-units of the field office, and calculate the weights for each of these units after the sample design has been completed. 

#### the design may be represented in simple mathematical terms

Using an example from a stratum which is of high land management importance, sagebrush-steppe, we illustrate the site selection process. While the aerial extent of sagebrush-steppe in the target frame is roughly one quarter (0.246), the stratum makes up one third (0.33) of all plots

In order to convey the number of plots drawn in any stratum the following equation is representative. 

$$
n \;=\; \dfrac{N * \pi_{i}} {1 / panels}
$$

+ $N$ the total number of plots in the sample design, *i.e. 255*
+ $\pi_{i}$ the inclusion probability of a plot in each stratum being drawn, *e.g. 0.33 targets the placement of a third of all plots to be put into the Sage-steppe Stratum*
+ $panels$ the number of design panels, *i.e. the number of years to stretch sampling across*

For sagebrush steppe we will then have: 

$$ 
16.83 \;=\; \dfrac{255 * 0.33 }{1/5}  
$$
plots for each panel, which will round down to 16 in order to accommodate representation of some of our other strata.


The **weight** of a plot is the amount of acres it represents within a stratum, we utilize this metric to help derive *measures of uncertainty* while making inference from our sampled plots to the whole stratum. 

$$
W_{i} = \dfrac{Stratum_{area}}{n}
$$

+ ${W_{i}}$ the weight acres, *i.e. the area which a plot represents within the target frame*
+ ${Stratum_{area}}$ the total area of the stratum in the area of analysis *e.g. 214,023 acres of sage-steppe*
+ ${n}$ the total number of plots in a stratum *e.g. for a panel of sage steppe 16*

Each sagebrush-steppe plot will have a weight of

$$
13,376 \;=\; \dfrac{214,023}{16}
$$
acres per plot, which it represents. 

### Areas of Analysis

The original AIM design covers the entire target frame of the UFO field office. However, a few additional analytical and management sub-units exist within this extent. There are three planning areas each with their own management objectives. The two National Conservation Areas associated with the UFO - the Gunnison Gorge & Dominguez-Escalente - the latter of which is partially administered by the Grand Junction Field Office (GJFO), are associated with their own Planning Areas. Likewise both within those, and across the Field office, there are numerous Wilderness Study Areas (WSA's), and Area's of critical Environmental Concern (ACEC's). As discussed later, the UFO intends these areas to have higher proportions of certain vegetation metrics relative to the remainder of BLM land. 

The Uncompahgre Resource Management Plan, completed in June 2019 covers 675,800 acres of the field office, and provides the definitive source of management objectives for the Field Office (summarized in VEG-OBJ-01 in Section II p. 23):

> "*Maximize native vegetation and natural processes by ensuring upland vegetation communities are within the range of natural variability, with an appropriate mix of plant functional groups, cover, and diversity, according to best available science on greater than 80 percent of vegetation communities in ACECs, WSAs, suitable WSR segments, and lands managed to minimize impacts on wilderness characteristics and on greater than 70 percent of vegetation communities on the remaining BLM- administered lands, over 10 years with 80 percent confidence.*" 
> `r tufte::quote_footer('--- RMP 2019')`

```{r Import and tidy data}

rm(min_el, max_el)
p2d <- '../data/raw'

plot_status <- read.csv(file.path(p2d, list.files(path = p2d, pattern = "summary.csv")))  %>% 
  mutate(across(.cols = everything(), ~ str_to_lower(.))) %>% 
  
  # humans are humans and typos are an expression of humanity. also  add a 
  # factor levels which we arrange by and slice the top from . 
  mutate(
    Plot.Status = str_trim(Plot.Status, side = "both"),
  #  Plot.Status = str_replace(Plot.Status, 'rejected', 'not_sampled'),
    Plot.Status = str_replace(Plot.Status, " ", "_"),
    psF = factor(Plot.Status, levels = c('sampled', 'not_sampled', 'rejected'))
    ) %>%  
  
  # some numbers are missing leading zereos
  separate(Plot.ID, into = c('stratum', 'id'), sep = '-') %>% 
  mutate(id = str_pad(id, 3, pad = "0")) %>% 
  
  # group up - and take that 'sampled' from the top - if present
  unite('Plot.ID', stratum:id, sep = "-", remove = F) %>% 
  group_by(Plot.ID) %>% 
  arrange(psF) 

# some plots were not sampled in one year, but subsequently sampled
status_check <- plot_status %>% # we want to ensure all of these plots are returned as sampled. 
  mutate(grp_n = n()) %>% 
  filter(grp_n >= 2, Plot.Status == 'sampled')

plot_status <- plot_status %>% 
  slice_head(n = 1) %>% 
  ungroup()

# inner_join(plot_status, status_check, by = 'Plot.ID') # take a look for yourself, all good. 

# it turns out some oversamples from the original design were not populated over to the yearly tracking 
# sheets. We can note there status as not_sampled here. 
plot_status <- plot_status %>% 
  mutate(across(.cols = Plot.ID:stratum, ~ str_to_upper(.x)))
pts <- st_read(
  '../../aimDB/data/raw/AIM_Sample_Design/AIM_Design_Stratification.shp',
                quiet = T) %>% 
  left_join(., plot_status, by = c('PLOTID' = 'Plot.ID')) %>% 
  select(-Panel) %>%  
  separate(PLOTID, into = c('stratum', 'id'), sep = '-', remove = F) %>% 
  mutate(across(Plot.Status:psF, ~ replace_na(.x, 'not_sampled'))) %>%  
  # some over samples were not completed
  select(Plot.ID = PLOTID, stratum, id, Panel = PANEL, Plot.Status, psF, xcoord, ycoord, geometry)
  
# st_write(pts, 
#          '/media/sagesteppe/ExternalHD/UFO_cartography/AIM_plots_outcomes/plots_outcomes.shp',
#          quiet = T)

plot_status <- pts %>% 
  select(colnames(plot_status)) %>% 
  st_drop_geometry()

plot_summary <- plot_status %>% 
  group_by(stratum, Plot.Status) %>% 
  summarise(n = n())  %>% 
  ungroup(Plot.Status) %>% 
  mutate(total = sum(n)) %>% 
  pivot_longer(n:total, values_to = 'Number') %>% 
  mutate(Plot.Status = if_else(name == 'total', 'total', Plot.Status)) %>% 
  select(-name) %>% 
  group_by(stratum, Plot.Status) %>% 
  sample_n(1)

rm(status_check)

# format table for printing
plot_summary <- plot_summary %>% 
  pivot_wider(values_from = Number, names_from = Plot.Status) %>% 
  mutate(stratum = str_to_upper(stratum)) %>% 
  mutate(across(.cols = everything(), ~ replace_na(.x, 0))) %>% 
  rename_with(., ~ str_to_sentence(.))

# DERIVE THE VALUES FOR BOTH TOTAL AREA AND AREAS IN ACRES
r <- read.csv(file.path(p2d, 'UFO_strata_areas.csv')) %>% 
  mutate(ProportionalArea = Cells/sum(Cells)) %>% 
  select(Stratum, Code, ProportionalArea, Acres)  # these need to have the other areas subtracted...

deSS <- data.frame( # desired sample size per stratum over live of sample design
  'Stratum' = c("AS", "GR", "MC", "MMS", "OT" , "PJ", "PP", "RI", "SD" , "SS" ), 
  'DesiredSS' = c(5, 5, 15, 25, 5, 25, 5, 15, 75, 80),
  'PropTarget' = c(0.01, 0.02, 0.05, 0.1, 0.01, 0.12, 0.01, 0.05, 0.3, 0.33)
) 

OriginalWeights <- left_join(plot_summary, r, by = c('Stratum' = 'Code')) %>% 
  left_join(., deSS, by = 'Stratum') %>% 
  select(StratumName = Stratum.y, Stratum, Total,  NotSampled = Not_sampled, Rejected, Sampled, 
          DesiredSS, PropArea = ProportionalArea, PropTarget, Acres) %>% 
  mutate(ApproxStWgt = Acres / (DesiredSS/5))

OriginalWeights %>% 
  mutate(PropArea = round(PropArea, 3)) %>% 
  mutate(across(.cols = c(Acres, ApproxStWgt),  round)) %>% 
  arrange(-Acres) %>% 
  ungroup() %>% 
  select(Stratum, Acres, PropArea, PropTarget, DesiredSS, ApproxStWgt) %>% 
  knitr::kable(., digits = 2, format.args = list(big.mark = ","), booktabs = T,
               col.names = c('Stratum', 'Area (acres)', 'Prop. Area',
                             'Prop. Site', 'No. Plots', 'Plot Wt.'),
               caption = "Original Sample Design for the Entire Sample Frame", 
               align = c("c", rep('r', times = (ncol(.) - 1))))  %>% 
  kable_styling(full_width = F)

rm(r, plot_summary)
```

\newpage

## All land, less species status

\begin{wrapfigure}{l}{0.35\textwidth}
  \centering
    \includegraphics[width=0.35\textwidth]{../graphics/maps/AIMPlots.png}
  \caption{All plots sampled across the entirety of the field office}
\end{wrapfigure}

> "*greater than 70 percent of vegetation communities on (the remaining) BLM-administered lands*"
> 
> `r tufte::quote_footer('--- RMP 2019')`

The majority of land administered by the field office does not fall under any special regulatory status, such as those which are present for the Areas of Critical Environmental Concern (ACEC's), Wilderness [Study] Areas, and National Conservation Areas. The initial AIM sample design covered the entirety of the Field Office, and did not separate out, or weigh, the special regulatory areas from the majority of BLM administered land. However, given that this area is managed differently than the following three other areas, and that it has different management objectives with more tolerance to certain kinds of uses, we split this area out retroactively. Here we assess the location of the AIM plots drawn in the original sample design, and using spatial techniques assign them to this area. We then determine the weights of plots under the scenario that all plots were sampled (Table 1), and under the realized condition that only certain plots were sampled (Table 2). Generally, we would only be performing the second action at the end of the sampling.

```{r import some spatial products}
spatial_products <- '../../UFO_cartography'
uFO <- st_read(file.path(spatial_products, 
                         'BLM_CO_Surface_Management/BLM_CO_Surface_Management_Agency.shp'), quiet = T)

monuments <- st_read(file.path(spatial_products, 'BLM_CO_NM_NCA/nlcs_nm_nca_poly.shp'), 
                 quiet = T) %>% 
  st_intersection(uFO, .) %>% 
  group_by(NLCS_NAME) %>% 
  st_collection_extract("POLYGON")  %>%  # there are these funny points
  summarize(geometry = st_union(geometry)) %>% 
  rename(NAME = NLCS_NAME)

acecs_all <- st_read(file.path(spatial_products, 'BLM_CO_ACEC/acec_desig_poly.shp'), 
                 quiet = T) %>%  
  st_intersection(uFO, .) %>% 
  select(NAME = ACEC_NAME) %>% 
  mutate(TYPE = 'ACEC',  .before = geometry)  %>% 
  filter(NAME != 'Sinbad Valley ACEC') %>%
  group_by(NAME) %>% 
  summarize(geometry = st_union(geometry))
```

```{r Adjust the Sample Point Weights across entire Field Office}

uFO_remains <- st_difference(uFO, st_union(monuments)) %>% 
  st_difference(., st_union(acecs_all))

pts_base <- pts %>% 
  st_transform(., st_crs(uFO_remains)) %>% 
  st_intersection(., uFO_remains)

Full_newWghts <- plotWeigher(OriginalWeights, pts_base)

Full_newWghts %>% 
  mutate(across(TotalAcres:WgtAcres, ~ round(.x, 3))) %>% 
  mutate(across(PlotsSampled:PlotsRejected, ~ replace_na(.x, 0))) %>% 
  arrange(-TotalAcres) %>% 
  select(Stratum, WghtPerPlot, WgtAcres, PlotsSampled, PlotsRejected) %>% 
  knitr::kable(., digits = 3, format.args = list(big.mark = ","), booktabs = T,
               col.names = c('Stratum',  'Plot Wt.', 'Plot Wt. Ac.', 'Sampled', 'Rejected'),
               caption = "Realized Weighted Sample Design for the Entire Sample Frame", 
               align = c("c", rep('r', times = (ncol(.) - 1)))) %>% 
  kableExtra::add_header_above(., c(" " = 3,  "No. Plots" = 2)) %>% 
  kableExtra::kable_styling(latex_options = "hold_position")

OriginalWeights_results <- mutate(OriginalWeights, 'Area' = 'SampleFrame') %>% 
  select(-any_of(c('StratumName')))
NewWeights_results <- mutate(Full_newWghts, 'Area' = 'SampleFrame') %>% 
  select(-any_of(c('StratumName')))

rm(OriginalWeights, Full_newWghts, pts_base)
```

The strata of Mixed Conifer and Aspen, both had fewer plots sampled than the sample design called for. Both of these areas are relatively rare across the field office, and accordingly had very few initial plots drawn for each of them. The inability to sample these is due to several of the drawn base points and over sample plots being located on parcels of land, which required permission from private land owners to access, but which were denied; or were on areas with very high slopes, which were unsafe to sample. While we are able to use these plot weights to infer across the field office on the whole, we note that a discrepancy existed between the actual distribution of these areas in the office and the plots classified as such (Section 2). While we regret not being able to sample these plots, most of the drawn locations were actually in Mixed Mountain Shrub, an area which was weighed to have extra plots and which was successfully sampled.

Aside from these two strata, all other strata had more plots sampled than expected. Because the area of inference which these plots speak to cannot change, the weight of each individual plot decreases in this scenario. In simpler terms, each plot represents a smaller unit of area. In the case of the Mixed Conifer and Aspend plots, each plot represents more area than intended.

###  Areas of Critical Environmental Concern (ACEC's) and Wilderness Study Areas (WSA)

```{r Import National Conservation Areas}

DEnm <- monuments %>% filter(str_detect(NAME, 'Dominguez')) %>% 
  mutate(ID = 1:n(), .before = 1, TYPE = 'NM')

GGnm <- monuments %>% filter(str_detect(NAME, 'Gunnison')) %>% 
  mutate(ID = 1:n(), .before = 1, TYPE = 'NM')

# ggplot() +
#  geom_sf(data = monuments) +
#  geom_sf(data = acecs, fill = 'red', alpha = 0.5)
```


```{r Original Point weights for ACEC and WSA}

design_rast <- '../../UFO_AIM_Design_Stratification/processed'
lookup_table <- read.csv(file.path(design_rast, 'UFO_strata_areas.csv')) %>% 
  select(RasterValue, Code)

strat_raster <- terra::rast(file.path(design_rast, 'UFO_Strata_reclass_30m.tif'))
acecs_all <- st_read(file.path(spatial_products, 'BLM_CO_ACEC/acec_desig_poly.shp'), 
                 quiet = T) %>%  
  st_intersection(uFO, .) %>% 
  select(NAME = ACEC_NAME) %>% 
  mutate(TYPE = 'ACEC',  .before = geometry)  %>% 
  filter(NAME != 'Sinbad Valley ACEC') %>%
  group_by(NAME) %>% 
  summarize(geometry = st_union(geometry))

t_acecs <- nrow(acecs_all)
acecs <- acecs_all %>% 
  filter(!NAME %in% c('Native Plant Community ONA', 'River Rims ACEC', 'Escalante Canyon ACEC'))

wsa <- st_read(file.path(spatial_products, 'BLM_CO_WSA/nlcs_wsa_poly.shp'), 
               quiet = T) %>% 
  st_intersection(uFO, .) %>% 
  select(NAME = NLCS_NAME) %>% 
  filter(!NAME %in% c('Sewemup Mesa', 'American Flats'))

wsa <- st_intersection(wsa, uFO) %>% 
  group_by(NAME) %>% 
  filter(NAME != 'Dominguez') %>%
  summarize(geometry = st_union(geometry)) %>% 
  st_collection_extract('POLYGON') %>% 
  mutate(TYPE = 'WSA', .before = geometry) 

wa <- st_read(file.path(spatial_products, 'BLM_CO_WA_official/nlcs_wa_poly.shp'), 
               quiet = T) %>% 
  st_intersection(uFO, .) %>% 
  select(NAME = NLCS_NAME) %>% 
  mutate(TYPE = 'WA', .before = geometry) %>% 
  filter(NAME != 'Uncompahgre')

wsAcec <- bind_rows(acecs, wsa) %>% 
  mutate(ID = 1:n(), .before = 1)

wsAcec_OriginalWeights <- originalWeights(sample_area = wsAcec,
                                          strat_raster = strat_raster, pt_data = pts)
wsAcec_pts <- wsAcec_OriginalWeights[[1]] # we return a list with the points needed for recalculating the weights
wsAcec_OriginalWeights <- wsAcec_OriginalWeights[[2]]
```

The Uncompahgre Field office has `r t_acecs` unique Areas of Critical Environmental Concern. The focus of these areas range from conserving Archaeological sites, sections of Rivers, and rare plant localities. Many of these areas are relatively small, and scattered across the entirety of the field office, the locations under this analytical unit will include those which cannot be combined the National Conservation Areas. Three of the ACEC's are nearly entirely contained within National Conservation Areas, and will not be included in the analyses for this section, but rather the NCA which they are surrounded by. Both of the field offices two wilderness areas, are also contained entirely within National Conservation Areas, and they also will be included in analysis and discussion within the NCA which contains them.

The office has four Wilderness Study Areas, one of which is largely encompassed by a National Conservation Areas, and will be included in the analyses there, rather than here.

```{r wsAcec original weights table}
wsAcec_OriginalWeights %>% 
  mutate(PropArea = round(PropArea, 3)) %>% 
  mutate(across(.cols = c(Acres, ApproxStWgt),  round)) %>% 
  arrange(-Acres) %>% 
  ungroup() %>% 
  select(Stratum, Acres, PropArea, PropTarget, DesiredSS, ApproxStWgt) %>% 
  knitr::kable(., digits = 2, format.args = list(big.mark = ","), booktabs = T,
               col.names = c('Stratum', 'Area (acres)', 'Prop. Area', 
                             'Prop. Site', 'No. Plots', 'Plot Wt.'),
               caption = "Original Sample Design for Areas of Critical Environmental Concern and Wilderness Study Areas", 
               align = c("c", rep('r', times = (ncol(.) - 1))))  %>% 
  kableExtra::kable_styling(latex_options = "hold_position")

rm(raster_cells, wsaSpat, wsAcec_area_summary, wsAcec_pt_draw,
   base_wsAcec_pts, raster_cells, wsAcec_areas, design_rast, t_acecs)
```

The reporting units of Areas of Critical Environmental Concern (ACEC's), and Wilderness Study Areas (WSA), and Wilderness Areas, have different management objectives relative to the remaining BLM administered surface area. Loosely, they are intended to have a higher percentage of the vegetation communities within the natural range of variation: 

> "*greater than 80 percent of vegetation communities in ACEC's, WSA's...*" 
> `r tufte::quote_footer('--- RMP 2019')`

These areas were not intensified units within the original sample design, rather we split them out here using the original point draw for the field office. Here we calculate the initial sample weights for them using the same approach as for the remainder of BLM land, i.e. the acreage of each stratum is weighed against a targeted proportion of plots in the region. As our sample design was initiated and completed during a period of drought (Section 6), we dismiss the possibilities of making temporal comparisons across the sample panels. Accordingly, we have strata within these management units which: do not have a point per year panel (i.e. cannot be sampled each year). Subsequently, we do not have the initial ability to infer across the entire acreage of each stratum within them. 

Strata with five or more plots, would allow for temporal analyses to be conducted on their data. Strata with less than five plots can only be treated as static entities within this time period.

```{r acec wsa table}

acecs <- acecs %>% group_by(NAME) %>% 
  summarize(geometry = st_union(geometry))

acec_pts <- st_intersection(st_transform(wsAcec_pts, st_crs(acecs)) , acecs) %>% 
  group_by(NAME) 

acec_bp_drawn <- acec_pts %>% 
  filter(str_detect(Panel, 'Sample', negate = T)) %>% 
  group_by(NAME) %>% 
  count(name = 'total_plots') %>% 
  st_drop_geometry()

acec_pts_sampled <- acec_pts %>% 
  filter(Plot.Status == 'sampled') %>% 
  group_by(NAME) %>% 
  count(name = 'sampled') %>% 
  st_drop_geometry() %>% 
  
  left_join(., acec_bp_drawn, by = 'NAME') %>% 
  right_join(., acecs , by = 'NAME') %>% 
  
  st_drop_geometry() %>% 
  select(NAME, total_plots, sampled) %>% 
  distinct() %>% 
  mutate(across(where(is.numeric), ~ replace_na(.x, 0))) %>% 
  filter(total_plots > 0)

# wsa <- wsa %>% group_by(NAME) %>% 
#  summarize(geometry = st_union(geometry)) # wsa are off. 

acecs %>% 
  mutate(Area = round(as.numeric(units::set_units(st_area(.), "acre")), 0)) %>% 
  st_drop_geometry() %>% 
  arrange(-Area) %>% 
  left_join(., acec_pts_sampled)  %>% 
  mutate(across(where(is.numeric), ~ replace_na(.x, 0))) %>% 
  knitr::kable(., digits = 2, format.args = list(big.mark = ","), booktabs = T,
               col.names = c('Name', 'Area (ac.)', 'Drawn', 'Sampled'),
                             caption = "Number of Plots Drawn per ACEC",               
               align = c("c", rep('r', times = (ncol(.) - 1)))) %>% 
  kableExtra::add_header_above(., c(" ", "", "No. Plots" = 2)) %>% 
  kableExtra::kable_styling(latex_options = "hold_position")

```

As can be seen in table 4, not every Area of Critical Environmental Concern was able to have an AIM plot located in it. Roughly only half of them had an AIM plot located in them. This is due to them being relatively small in size, the number of AIM plots being relatively few. An alternative AIM sample design, for one of the frames, may require the placement of a plot into each of these individual areas in order to determine long term trends in them. This would allow for determining whether passive management actions in these areas were achieving goals. 

Two of the ACEC's which had AIM plots located in them, Adobe Badlands and San Miguel River, did not have as many plots sampled within them as the sample design called for. In both instances this is most likely due to the plots being on hill slopes which were unsafe to sample. However, oversample plots were sampled in other ACEC units, leading to an appropriate number of plots being sampled across the entire area.

```{r Final Point weights for ACEC and WSA}
wsAcec_newWghts <- plotWeigher(wsAcec_OriginalWeights, wsAcec_pts)

wsAcec_newWghts %>% 
  mutate(across(TotalAcres:WgtAcres, ~ round(.x, 3))) %>% 
  mutate(across(PlotsSampled:PlotsRejected, ~ replace_na(.x, 0))) %>% 
  arrange(-TotalAcres) %>%  
  select(Stratum, WghtPerPlot, WgtAcres, PlotsSampled, PlotsRejected) %>% 
  knitr::kable(., digits = 2, format.args = list(big.mark = ","), booktabs = T,
               col.names = c('Stratum',  'Plot Wt.', 'Plot Wt. Ac.', 'Sampled', 'Rejected'),
               caption = "Realized Weighted Sample Design for the ACEC-WSA", 
               align = c("c", rep('r', times = (ncol(.) - 1)))) %>% 
  kableExtra::add_header_above(., c(" " = 3,  "No. Plots" = 2)) %>% 
  kableExtra::kable_styling(latex_options = "hold_position")

OriginalWeights_results <- bind_rows(OriginalWeights_results, wsAcec_OriginalWeights %>% 
                                       mutate('Area' = 'ACEC-WSA'))
NewWeights_results <- bind_rows(NewWeights_results, wsAcec_newWghts %>% 
                                       mutate('Area' = 'ACEC-WSA'))
points <- pts %>% 
  mutate('AoInference' = if_else(Plot.ID %in% wsAcec_pts$Plot.ID, 'ACEC-WSA', 'unassigned')) 

#NoStrata(wsAcec_newWghts)

rm(wsAcec_OriginalWeights, wsAcec_pts, wsAcec_newWghts)
```

More AIM plots in Mixed-Mountain Shrub and Pinyon-Juniper were sampled than drawn in the sample design. Accordingly, these plots are weighted to speak to lower amounts of area than initially noted in the sample design. Fewer Sagebrush plots were sampled than intended, and the weight of the sample plots has been increased to compensate for the deficit.

\newpage

### Dominguez-Escalente National Conservation Area

```{r Original Point weights for Dominguez-Escalente NCA}

DEnm <- monuments %>% filter(str_detect(NAME, 'Dominguez')) %>% 
  mutate(ID = 1:n(), .before = 1, TYPE = 'NM')

OW_deNM <- originalWeights(DEnm, strat_raster, pts)
OW_deNM_pts <- OW_deNM[[1]]
OW_deNM <- OW_deNM[[2]]

OW_deNM %>% 
  mutate(PropArea = round(PropArea, 3)) %>% 
  mutate(across(.cols = c(Acres, ApproxStWgt),  round)) %>% 
  arrange(-Acres) %>% 
  ungroup() %>% 
  select(Stratum, Acres, PropArea, PropTarget, DesiredSS, ApproxStWgt) %>% 
  knitr::kable(., digits = 2, format.args = list(big.mark = ","), booktabs = T,
               col.names = c('Stratum', 'Area (acres)', 'Prop. Area', 
                             'Prop. Site', 'No. Plots', 'Plot Wt.'),
               caption = "Original Sample Design for Dominguez-Escalante NCA", 
               align = c("c", rep('r', times = (ncol(.) - 1)))) %>% 
  kableExtra::kable_styling(latex_options = "hold_position")

dc_wild <- filter(wa, NAME == 'Dominguez Canyon') %>% 
  st_union()

acecs_de <- filter(acecs_all, NAME %in% c('River Rims ACEC', 'Escalante Canyon ACEC')) %>% 
  st_union()

rm(uFO, p2d, spatial_products)
```

\begin{wrapfigure}{l}{0.35\textwidth}
  \centering
    \includegraphics[width=0.35\textwidth]{../graphics/maps/DominguezEscalenteAIMPlots.png}
  \caption{All plots sampled in the vicinity of the National Conservation Area, by both the UFO and Grand Junction Field Office. The GJFO is North (towards the top of the page) of the black line running across the map.}
\end{wrapfigure}

The Dominguez-Escalente National Conservation Area is joint administered with the Grand Junction Field Office, all values here refer only to the portions administered by the UFO field office. As previously mentioned, this area contains both a Wilderness Study Area (The Dominguez WSA), which follows the course of the Gunnison River. It also contains a Wilderness area (The Dominguez Canyon Wilderness), largely composed of  difficult to access Pinyon-Juniper woodlands, which grade into Mixed Mountain Shrub in the higher elevations. This NCA also contains two Areas of Critical Environmental Concern (River Rim, and Escalente Canyon), both of which are essentially totally surrounded by the NCA. As expected, River Rim is four large parcels of land adjacent to the Gunnison River, three of which are in lands administered by the UFO field office. The Escalente Canyon ACEC is wholly located within the UFO administered portions of the NCA, and is comprised of Pinyon-Juniper Woodlands atop a mesa. 
 
The total area of the Dominguez-Escalente NCA administered by the UFO field office is `r TArea(DEnm)`, of which `r TArea(dc_wild)` is comprised of the Dominguez Canyon Wilderness, and `r TArea(acecs_de)` by the two ACEC's. The lowest elevation bands in the area comprise riparian vegetation along the Gunnison River, and narrow riparian areas along a variety of the canyon bottoms feeding into the Gunnison. A large portion of the vegetation just outside of the riparian area is Salt Desert, and Pinon-Juniper composes the majority of the remaining areas, much of which is on top of Mesas. `r sum(OW_deNM$DesiredSS)` total AIM plots were drawn throughout the area, this relatively high number is due to much of the area being categorized as being Sagebrush vegetation under the original sample stratification surface. Another contributing factor was tiny flecks of mixed woodlands at the upper boundary of the parcel, given that the office has small amounts of Aspen, Mixed Conifer, and Ponderosa Pine, these areas had points drawn in them. Realistically these areas are mostly mixed-mountain shrub. 

```{r Final Point Weights for Dominguez-Escalente NCA}

OW_newWghts <- plotWeigher(OW_deNM, OW_deNM_pts)
OW_newWghts %>% 
  mutate(across(TotalAcres:WgtAcres, ~ round(.x, 3))) %>% 
  mutate(across(PlotsSampled:PlotsRejected, ~ replace_na(.x, 0))) %>% 
  arrange(-TotalAcres) %>%
  select(Stratum, WghtPerPlot, WgtAcres, PlotsSampled, PlotsRejected) %>% 
  knitr::kable(., digits = 2, format.args = list(big.mark = ","), booktabs = T,
               col.names = c('Stratum',  'Plot Wt.', 'Plot Wt. Ac.', 'Sampled', 'Rejected'),
               caption = "Realized Weighted Sample Design for Dominguez-Escalente", 
               align = c("c", rep('r', times = (ncol(.) - 1)))) %>% 
  kableExtra::add_header_above(., c(" " = 3,  "No. Plots" = 2))

OriginalWeights_results <- bind_rows(OriginalWeights_results, OW_deNM %>% 
                                       mutate('Area' = 'DE-NM'))
NewWeights_results <- bind_rows(NewWeights_results, OW_newWghts %>% 
                                       mutate('Area' = 'DE-NM'))
points <- points %>% 
  mutate(AoInference = if_else(Plot.ID %in% OW_deNM_pts$Plot.ID, 'DE-NM', AoInference))

rm(OW_deNM, OW_newWghtsm, de_only, dearea, acecs_de, deNM)
```

The three plots drawn in the Aspen and Mixed Conifer strata were unable to be sampled, as mentioned due to the isolated and difficult topography of portions of the NCA. One plot fewer than desired in the drawn Sagebrush stratum was sampled, however more plots than expected were sampled in the Pinyon-Juniper and Salt Desert strata. Many of the over samples for 'Other', a stratum which was created by pooling many uncommon vegetation strata, were located in the Monument, but where not sampled. Many of these were located on escarpments. 

\newpage

### Gunnison Gorge National Conservation Area

```{r Gunnison Gorge area, results = 'hide'}
GGnm <- monuments %>% filter(str_detect(NAME, 'Gunnison')) %>% 
  mutate(ID = 1:n(), .before = 1, TYPE = 'NM')

GG_NM <- originalWeights(GGnm, strat_raster, pts)
GG_NM_pts <- GG_NM[[1]]
GG_NM <- GG_NM[[2]]

gg <- filter(wa, NAME == 'Gunnison Gorge') %>% st_union()
gg_grouse <- filter(acecs, NAME == 'Gunnison Sage-Grouse IBA') %>% 
  st_intersection(GGnm, .) %>% 
  st_collection_extract('POLYGON') %>% 
  st_union()

```

```{r Original Point Weights for Gunnison Gorge NCA}

GG_NM %>% 
  mutate(PropArea = round(PropArea, 3)) %>% 
  mutate(across(.cols = c(Acres, ApproxStWgt),  round)) %>% 
  arrange(-Acres) %>% 
  ungroup() %>% 
  select(Stratum, Acres, PropArea, PropTarget, DesiredSS, ApproxStWgt) %>% 
  knitr::kable(., digits = 2, format.args = list(big.mark = ","), booktabs = T,
               col.names = c('Stratum', 'Area (acres)', 'Prop. Area', 
                             'Prop. Site', 'No. Plots', 'Plot Wt.'),
               caption = "Original Sample Design for Gunnison Gorge NCA", 
               align = c("c", rep('r', times = (ncol(.) - 1)))) %>% 
  kableExtra::kable_styling(latex_options = "hold_position")

rm(deSS, lookup_table, monuments, strat_raster)
```

\begin{wrapfigure}{l}{0.35\textwidth}
  \centering
    \includegraphics[width=0.35\textwidth]{../graphics/maps/GunnisonGorgeAIMPlots.png}
  \caption{All plots sampled in the vicinity of the National Conservation Area}
\end{wrapfigure}

The Gunnison Gorge National Conservation Area encompasses `r TArea(GGnm)` acres, and runs along the Gunnison River downstream of the Black-Canyon of the Gunnison National Park. Despite the enormity of the gorge, this area does not have significant topographic differences as are found on larger parcels of land, and as a result features only `r NoStrata(GG_NM)` of the original vegetation strata in the design. It is the only sub-unit of the AIM sample design which is comprised primarily of salt desert, which is featured prominently along the Western portions of it. It also contains significant portion of Pinon-Juniper, adjacent to the cliffs overlooking the gorge, and some of the field offices best Sagebrush-Steppe along the Eastern portions.

As previously mentioned, this NCA contains a wilderness area, and an ACEC. The Native Plant Community ONA which is located along the Western Rim of the gorge is roughly `r TArea( filter(acecs_all, NAME == 'Native Plant Community ONA'))` acres, unfortunately no points were drawn in this area. The Wilderness in the center of the NCA is roughly `r TArea(gg)` acres, and is a very popular rafting destination. Accordingly points which were located in this wilderness proved challenging to sample. A single portion of the 'Gunnison Sage-Grouse IBA', comprising roughly `r TArea(gg_grouse)` acres overlays this NCA, and it is included in analyses of it, despite not having any plots drawn or sampled in it.

```{r Final Points Weights for Gunnison Gorge NCA}

GG_newWghts <- plotWeigher(GG_NM, GG_NM_pts)
GG_newWghts %>% 
  mutate(across(TotalAcres:WgtAcres, ~ round(.x, 3))) %>% 
  mutate(across(PlotsSampled:PlotsRejected, ~ replace_na(.x, 0))) %>% 
  arrange(-TotalAcres) %>%
  select(Stratum, WghtPerPlot, WgtAcres, PlotsSampled, PlotsRejected) %>% 
  knitr::kable(., digits = 2, format.args = list(big.mark = ","), booktabs = T,
               col.names = c('Stratum',  'Plot Wt.', 'Plot Wt. Ac.', 'Sampled', 'Rejected'),
               caption = "Realized Weighted Sample Design for the Gunnison Gorge NCA", 
               align = c("c", rep('r', times = (ncol(.) - 1)))) %>% 
  kableExtra::add_header_above(., c(" " = 3,  "No. Plots" = 2)) %>% 
  kableExtra::kable_styling(latex_options = "hold_position")

OriginalWeights_results <- bind_rows(OriginalWeights_results, GG_NM %>% 
                                       mutate('Area' = 'GG-NM'))
NewWeights_results <- bind_rows(NewWeights_results, GG_newWghts %>% 
                                       mutate('Area' = 'GG-NM'))
points <- points %>% 
  mutate(AoInference = if_else(Plot.ID %in% GG_NM_pts$Plot.ID, 'GG-NM', AoInference)) 

rm(pts, GG_newWghts, ggarea)
```

Of the `r drawnStrata(GG_NM)` strata which had plots drawn within the NCA, only three were successfully sampled. Twice as many Salt Desert plots were sampled as desired, and each of them accordingly has half the acres associated with them as intended. Only one of the two Pinyon-Juniper plots were sampled, hence it's weight is doubled to account for all acres in the original stratum. Fewer Sagebrush plots were sampled than intended, and each is weightde to cover slightly more acres than in the original design. 

```{r write out results, eval = F}

points <- points %>% 
  mutate(AoInference = if_else(AoInference == 'unassigned', 'SampleFrame', AoInference)) %>% 
  st_drop_geometry() %>% 
  select(-any_of(c('psF','geometry','stratum', 'id')))

p <- '../data/processed'
write.csv(OriginalWeights_results, file.path(p, 'OriginalSampleDesignWeights.csv'), row.names = F)
write.csv(NewWeights_results, file.path(p, 'FinalSampleDesignWeights.csv'), row.names = F)
write.csv(points, file.path(p, 'PointsAreaOfInterence.csv'), row.names = F)

rm(OriginalWeights_results, NewWeights_results, points, p)
```

```{r}
rm(OriginalWeights_results, NewWeights_results, points, originalWeights, plotWeigher, GG_NM, gg)
```

\newpage 

### Summary of Plot Sampling Efforts

Considering all strata in each of the above units together, no clear biases existed in the success of plot sampling efforts with the exception of Mixed Conifer and Aspen plots. As previously indicated, these areas tend to be located at the Field Offices highest elevation locations. These localities are difficult to access due to 1) lack of permission from private land owners whose roads are required to access the area in an efficient manner, 2) steep slopes or treacherous terrain on plot making them unsafe to sample. 

```{r Alluvial tracking plot status, warning = F, fig.cap = 'Fates of all potential AIM plots from the Sample Design'}

ps <- plot_status %>% 
  filter(str_detect(Panel, 'OverSample', negate = T)) %>% 
  group_by(stratum, Plot.Status) %>% 
  count() %>% 
  mutate(across(where(is.numeric), ~ replace_na(.x, 0))) %>% 
  drop_na() %>% 
  bind_rows(., data.frame(
    stratum = 'GR', Plot.Status = 'rejected', n = 0)) %>% 
  mutate(Plot.Status = factor(Plot.Status, levels = c('sampled', 'rejected')),
         stratum = factor(
           stratum, levels =
             c('AS', 'SS', 'GR', 'MMS', 'OT', 'PJ', 'PP', 'SD', 'RI', 'MC'))) %>% 
  drop_na()

ggplot(data = ps,
       aes(axis1 = stratum, axis2 = Plot.Status, y = n), color = NA) +
  geom_alluvium(aes(fill = Plot.Status),  width = 0.15) +
  geom_stratum(color = 'grey85') +
  geom_text(stat = "stratum", aes(label = after_stat(stratum)), color = 'grey15') +
  scale_fill_manual(values = c('forestgreen', '#e71313')) +
  theme_void() +
  theme(legend.position = "none",
        plot.title = element_text(hjust = 0.5)) + 
  ggtitle("Fate of Potential Plots Across the Sample Design") 
 
rm(ps, plot_status)
```




