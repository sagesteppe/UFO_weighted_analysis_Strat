---
title: "Point Weights"
author: "steppe"
output:
  word_document: default
always_allow_html: true
---


This AIM study was designed with three major principals in mind. The first, was maximizing the number of environments which it represents across the field office. The UFO field office varies by nearly XXXX feet, XXXX average precipitation, XXXX average temperatures, and displays a diversity of environments; and this sample design included this entire range of variation. To ensure that these diverse areas were represented, ten major strata were identified *see table*, in order to ensure that they had plots located in them in order to evaluate their ecological *integrity*. However, the management concerns, actions, and heterogeneity (internal dissimilarity) of these strata differ. To best understand the ecological context of these strata, and what management actions the BLM may take, the proportion of plots were tailored to each stratum. The third principal was that all plots be randomly placed within the stratum, which allows *inference* to be made from plots to the, unsampled, entirety of the stratum. This *weighted sample design* allows us to maximize statistical understanding while minimizing the field effort required to undertake it. 

The initial sample design followed the general AIM implementation design to contain 255 plots to be sampled across five years. Sampling over a five year period is essential in order to ensure that plots are visited during periods wherein the vegetation is *reproductively active*, hence identifiable. A benefit of this prolonged time frame is that anomalous weather conditions are unlikely to affect the plots across the entire time period. For example, the condition of plots may be compared in a wet year, to a dry year, as referenced from a year with typical rainfall. In order to avoid random unexpected processes which cluster in space which may occur over the period of conducting the sample design, the entire design is split into a *panel* for each year of sampling. Each panel is composed of a subset of randomly selected points within the sample design and avoids missing swathes of the *target frame* during the sample period due to an event such as a prolonged wildfire. 


#### the design may be represented in simple mathematical terms

Using an example from a stratum which is of high land management importance, sagebrush steppe, we illustrate the site selection process. While the aerial extent of sagebrush-steppe in the target frame is roughly one quarter (0.246), the stratum makes up one third (0.33) of all sites.

In order to convey the number of plots drawn in any stratum the following equation is representative. 

$$
n \;=\; \dfrac{N * \pi_{i}} {1 / panels}
$$

+ $N$ the total number of plots in the sample design, *i.e. 255*
+ $\pi_{i}$ the inclusion probability of a plot in each stratum being drawn, *e.g. 0.33 targets the placement of a third of all plots to be put into the Sage-steppe Stratum*
+ $panels$ the number of design panels, *i.e. the number of years to stretch sampling across*

For sagebrush steppe we will then have: 

$$ 
16.83 \;=\; \dfrac{255 * 0.33 }{1/5}  
$$
plots for each panel, which will round down to 16 in order to accommodate representation of some of our other strata.


The **weight** of a plot is the amount of acres it represents within a stratum, we utilize this metric to help derive *measures of uncertainty* while making inference from our sampled plots to the whole stratum. 

$$
W_{i} = \dfrac{Stratum_{area}}{n}
$$
+ ${W_{i}}$ the weight acres, *i.e. the area which a plot represents within the target frame*
+ ${Stratum_{area}$ the total area of the stratum in the area of analysis *e.g. 214,023 acres of sage-steppe*
+ ${n}$ the total number of plots in a stratumm *e.g. for a panel of sage steppe 16*

Each sagebrush-steppe plot will have a weight of

$$
13,376 \;=\; \dfrac{214,023}{16}
$$
acres per plot, which it represents. 

#### Areas of Analysis

The original AIM design covers the entire target frame of the UFO field office. However, a few additional analytical  and management sub-units exist within this extent. Their are two National Monuments, the  Gunnison Gorge, and Dominguez-Escalente, which is partially administered by the Grand Junction Field Office (GJFO) which have different maangement directives which distinguish them from the majority of UFO land. Likewise there are numerous Wilderness Study Areas (WSA's), and Area's of critical Environmental Concern (ACEC's), throughout the field office. The UFO intends these areas to have higher proportions of certain metrics relative to the remainder of BLM land. 


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F)
knitr::opts_chunk$set(dpi = 300) 
knitr::opts_chunk$set(message = F)
knitr::opts_chunk$set(warning = F)
```

```{r Load libraries, warning = F, message = F, echo = F}
library(tidyverse)
library(sf)
library(terra)
library(spsurvey)
source('functions.R')
```

```{r}
p2d <- '../data/raw'

plot_status <- read.csv(file.path(p2d, list.files(path = p2d, pattern = "summary.csv")))  %>% 
  mutate(across(.cols = everything(), ~ str_to_lower(.))) %>% 
  
  # humans are humans and typos are an expression of humanity. also  add a 
  # factor levels which we arrange by and slice the top from . 
  mutate(
    Plot.Status = str_trim(Plot.Status, side = "both"),
  #  Plot.Status = str_replace(Plot.Status, 'rejected', 'not_sampled'),
    Plot.Status = str_replace(Plot.Status, " ", "_"),
    psF = factor(Plot.Status, levels = c('sampled', 'not_sampled', 'rejected'))
    ) %>%  
  
  # some numbers are missing leading zereos
  separate(Plot.ID, into = c('stratum', 'id'), sep = '-') %>% 
  mutate(id = str_pad(id, 3, pad = "0")) %>% 
  
  # group up - and take that 'sampled' from the top - if present
  unite('Plot.ID', stratum:id, sep = "-", remove = F) %>% 
  group_by(Plot.ID) %>% 
  arrange(psF) 

# some plots were not sampled in one year, but subsequently sampled
status_check <- plot_status %>% # we want to ensure all of these plots are returned as sampled. 
  mutate(grp_n = n()) %>% 
  filter(grp_n >= 2, Plot.Status == 'sampled')

plot_status <- plot_status %>% 
  slice_head(n = 1) %>% 
  ungroup()

# inner_join(plot_status, status_check, by = 'Plot.ID') # take a look for yourself, all good. 

# it turns out some oversamples from the original design were not populated over to the yearly tracking 
# sheets. We can note there status as not_sampled here. 
plot_status <- plot_status %>% 
  mutate(across(.cols = Plot.ID:stratum, ~ str_to_upper(.x)))
pts <- st_read(
  '/media/sagesteppe/ExternalHD/aimDB/data/raw/AIM_Sample_Design/AIM_Design_Stratification.shp',
                quiet = T) %>% 
  left_join(., plot_status, by = c('PLOTID' = 'Plot.ID')) %>% 
  select(-Panel) %>%  
  separate(PLOTID, into = c('stratum', 'id'), sep = '-', remove = F) %>% 
  mutate(across(Plot.Status:psF, ~ replace_na(.x, 'not_sampled'))) %>%  
  # some over samples were not completed
  select(Plot.ID = PLOTID, stratum, id, Panel = PANEL, Plot.Status, psF, xcoord, ycoord, geometry)
  
plot_status <- pts %>% 
  select(colnames(plot_status)) %>% 
  st_drop_geometry()

plot_summary <- plot_status %>% 
  group_by(stratum, Plot.Status) %>% 
  summarise(n = n())  %>% 
  ungroup(Plot.Status) %>% 
  mutate(total = sum(n)) %>% 
  pivot_longer(n:total, values_to = 'Number') %>% 
  mutate(Plot.Status = if_else(name == 'total', 'total', Plot.Status)) %>% 
  select(-name) %>% 
  group_by(stratum, Plot.Status) %>% 
  sample_n(1)

rm(status_check)

# format table for printing
plot_summary <- plot_summary %>% 
  pivot_wider(values_from = Number, names_from = Plot.Status) %>% 
  mutate(stratum = str_to_upper(stratum)) %>% 
  mutate(across(.cols = everything(), ~ replace_na(.x, 0))) %>% 
  rename_with(., ~ str_to_sentence(.))

# DERIVE THE VALUES FOR BOTH TOTAL AREA AND AREAS IN ACRES

r <- read.csv(file.path(p2d, 'UFO_strata_areas.csv')) %>% 
  mutate(ProportionalArea = Cells/sum(Cells)) %>% 
  select(Stratum, Code, ProportionalArea, Acres)

deSS <- data.frame( # desired sample size per stratum over live of sample design
  'Stratum' = c("AS", "GR", "MC", "MMS", "OT" , "PJ", "PP", "RI", "SD" , "SS" ), 
  'DesiredSS' = c(5, 5, 15, 25, 5, 25, 5, 15, 75, 80),
  'PropTarget' = c(0.01, 0.02, 0.05, 0.1, 0.01, 0.12, 0.01, 0.05, 0.3, 0.33)
) 

OriginalWeights <- left_join(plot_summary, r, by = c('Stratum' = 'Code')) %>% 
  left_join(., deSS, by = 'Stratum') %>% 
  select(StratumName = Stratum.y, Stratum, Total,  NotSampled = Not_sampled, Rejected, Sampled, 
          DesiredSS, PropArea = ProportionalArea, PropTarget, Acres) %>% 
  mutate(ApproxStWgt = Acres / (DesiredSS/5))

write.csv(OriginalWeights, '../data/processed/OriginalWeightsSampleDesign.csv', row.names = F)

OriginalWeights %>% 
  mutate(PropArea = round(PropArea, 3)) %>% 
  mutate(across(.cols = c(Acres, ApproxStWgt),  round)) %>% 
  arrange(-Acres) %>% 
  ungroup() %>% 
  select(StratumName, Acres, PropArea, PropTarget, DesiredSS, ApproxStWgt) %>% 
  knitr::kable(., digits = 2, format.args = list(big.mark = ","), 
               col.names = c('Stratum', 'Total Area (acres)', 'Prop. Area', 'Prop. Site', 'No. Sites', 'Plot Wt.'), 
               align = c("c", rep('r', times = (ncol(.) - 1)))) 
  
rm(r, plot_summary, plot_status)
```

```{r Adjust the Sample Point Weights across entire Field Office}

Full_newWghts <- plotWeigher(OriginalWeights, pts)

Full_newWghts %>% 
  mutate(across(TotalAcres:WgtAcres, ~ round(.x))) %>% 
  mutate(across(PlotsSampled:PlotsRejected, ~ replace_na(.x, 0))) %>% 
  arrange(-TotalAcres) %>% 
  select(Stratum, PropInference, TotalAcres:WgtAcres, PlotsSampled, PlotsRejected) %>% 
  knitr::kable(., digits = 2, format.args = list(big.mark = ","),
               col.names = c('Stratum', 'Inference Prop.', 'Area (acres)', 'Area to Infer', 'Plot Wt.', 'Sampled', 'Rejected'),
               align = c("c", rep('r', times = (ncol(.) - 1))))

# write.csv() ??
rm(OriginalWeights, Full_newWghts)
```


The reporting units of Areas of Critical Environmental Concern (ACEC's), and Wilderness Study Areas (WSA), have different management objectives relative to the remaining BLM administered surface area. These areas are intended to have " ... greater than 80 percent vegetation communities  ... ". These areas were not intensified units within the original sample design, rather we split them out here using the original point draw for the field office. Here we calculate the initial sample weights for them using the same approach as for the remainder of BLM land, i.e. the acreage of each stratum is weighed against a targeted proportion of sites in the region. As our sample design was initiated and completed during a period of drought (See...), we dismiss the possibilities of making temporal comparisons across the sample panels. Accordingly, we have strata within these management units which: do not have a point per year panel (i.e. cannot be sampled each year). Subsequently, we do not have the initial ability to infer across the entire acreage of each stratum within them. 



```{r Point weights for ACEC and WSA}

spatial_products <- '/media/sagesteppe/ExternalHD/UFO_cartography'
design_rast <- '/media/sagesteppe/ExternalHD/UFO_AIM_Design_Stratification/processed'
lookup_table <- read.csv(file.path(design_rast, 'UFO_strata_areas.csv')) %>% 
  select(RasterValue, Code)

uFO <- st_read(file.path(spatial_products, 
                         'BLM_CO_Grazing_Allotments/gra_allot_poly.shp'), quiet = T)
acecs <- st_read(file.path(spatial_products, 'BLM_CO_ACEC/acec_desig_poly.shp'), 
                 quiet = T) %>%  
  st_intersection(uFO, .) %>% 
  select(NAME = ACEC_NAME) %>% 
  mutate(TYPE = 'ACEC')
wsa <- st_read(file.path(spatial_products, 'BLM_CO_WSA/nlcs_wsa_poly.shp'), 
               quiet = T) %>% 
  st_intersection(uFO, .) %>% 
  select(NAME = NLCS_NAME) %>% 
  mutate(TYPE = 'WSA')

wsAcec <- bind_rows(acecs, wsa) %>% 
  mutate(ID = 1:n(), .before = 1)

rm(acecs, wsa)

# identify all points which fell in the focal areas
wsAcec_pts <- pts[unlist(st_intersects(wsAcec, st_transform(pts, st_crs(wsAcec)))),]

# identify the cover of each stratum in the focal area
wsaSpat <- vect(wsAcec) 
wsAcec_areas <- terra::expanse(wsaSpat, unit = 'ha') * 2.47105 # conversion to acres
TotalFocalArea <- sum(wsAcec_areas)
wsAcec_areas <- bind_cols(wsAcec, Total_Area =  wsAcec_areas, TotalFocalArea = TotalFocalArea)

strat_raster <- terra::rast(file.path(design_rast, 'UFO_Strata_reclass_30m.tif'))
wsaSpat <- project(wsaSpat, crs(strat_raster))

raster_cells <- extract(strat_raster, wsaSpat) %>% 
  group_by(ID, BPS_CODE) %>% 
  count() %>% 
  ungroup(BPS_CODE) %>% 
  mutate(PropArea = n/sum(n))  %>% 
  left_join(., lookup_table, by = c('BPS_CODE' = 'RasterValue'))

rm(wsaSpat, TotalFocalArea)

wsAcec_areas <- left_join(wsAcec_areas, raster_cells) %>% 
  mutate(Area = Total_Area * PropArea)  %>% 
  select(ID, NAME, TYPE, Total_Area, Code, PropArea, Area, TotalFocalArea)

wsAcec_area_summary <- wsAcec_areas %>% 
  ungroup() %>% 
  group_by(Code) %>% 
  mutate(TotalArea = sum(Area)) %>% 
  ungroup() %>% 
  distinct(Code, .keep_all = T) %>% 
  select(Stratum = Code, TotalArea, PropArea, TotalFocalArea) %>%
  mutate(PropArea = TotalArea/sum(TotalArea)) %>% 
  st_drop_geometry()

base_wsAcec_pts <- wsAcec_pts %>% 
  filter(str_detect(Panel, 'OverSample', negate = T))

# need to calculate the desired sites per stratum as function of plot weight. 
wsAcec_area_summary <- wsAcec_area_summary %>% 
  left_join(., deSS, by = 'Stratum') %>%  # desired ss total_area / wsAcec
  mutate(DesiredSS = round(DesiredSS * (nrow(base_wsAcec_pts)/255))) %>% 
  drop_na()

wsAcec_pt_draw <- wsAcec_pts %>% 
  group_by(stratum, Plot.Status) %>% 
  count() %>% 
  st_drop_geometry() %>% 
  pivot_wider(id_cols = stratum, names_from = Plot.Status, values_from = n, 
              values_fill = 0) %>% 
  rowwise() %>% 
  mutate(total = sum(across(not_sampled:sampled)), .before = 'not_sampled')

wsAcec_OriginalWeights <- left_join(wsAcec_area_summary, wsAcec_pt_draw,
                                    by = c('Stratum' = 'stratum')) %>% 
  select(Stratum, Total = total, NotSampled = not_sampled, Rejected = rejected, 
         Sampled = sampled, DesiredSS, PropArea, PropTarget, Acres =  TotalArea) %>% 
  mutate(ApproxStWgt =  if_else(DesiredSS >= 5, (Acres/DesiredSS) * 5, (DesiredSS/5) * Acres))

wsAcec_OriginalWeights <- drop_na(wsAcec_OriginalWeights)


wsAcec_OriginalWeights %>% 
  mutate(PropArea = round(PropArea, 3)) %>% 
  mutate(across(.cols = c(Acres, ApproxStWgt),  round)) %>% 
  arrange(-Acres) %>% 
  ungroup() %>% 
  select(Stratum, Acres, PropArea, PropTarget, DesiredSS, ApproxStWgt) %>% 
  knitr::kable(., digits = 2, format.args = list(big.mark = ","), 
               col.names = c('Stratum', 'Total Area (acres)', 'Prop. Area', 'Prop. Site', 'No. Sites', 'Plot Wt.'), 
               align = c("c", rep('r', times = (ncol(.) - 1)))) 


rm(raster_cells, wsaSpat, wsAcec, wsAcec_area_summary, wsAcec_pt_draw,
   base_wsAcec_pts, raster_cells, wsAcec_areas, design_rast)
```


Strata with five or more plots, would allow for temporal analyses to  be conducted on their data. Strata with less than five plots can only be treated as static entities within this time period 

```{r}
plotWeigher(wsAcec_OriginalWeights, wsAcec_pts)
rm(wsAcec_OriginalWeights, wsAcec_pts)
```









```{r Point weights for the National Monument writeups}

monuments <- st_read(file.path(spatial_products, 'BLM_CO_NM_NCA/nlcs_nm_nca_poly.shp'), 
                 quiet = T) %>% 
  st_intersection(uFO, .) %>% 
  group_by(NLCS_NAME) %>% 
  st_collection_extract("POLYGON")  %>%  # there are these funny points
  summarize(geometry = st_union(geometry)) %>% 
  mutate(ID = 1:n(), .before = 1)

mnmt_pts <- pts[unlist(st_intersects(monuments, 
                                     st_transform(pts, st_crs(monuments)))),]
mnmtSpat <- vect(monuments) %>% project(., crs(strat_raster))
mnmt_areas <- terra::expanse(mnmtSpat, unit = 'ha') * 2.47105 # conversion to acres
TotalFocalArea <- sum(mnmt_areas)
mnmt_areas <- bind_cols(ID = 1:2, Total_Area =  mnmt_areas, 
                        TotalFocalArea = TotalFocalArea)

raster_cells <- extract(strat_raster, mnmtSpat) %>% 
  group_by(ID, BPS_CODE) %>% 
  count() %>% 
  ungroup(BPS_CODE) %>% 
  mutate(PropArea = n/sum(n))  %>% 
  left_join(., lookup_table, by = c('BPS_CODE' = 'RasterValue'))

rm(mnmtSpat, TotalFocalArea)

mnmt_areas <- left_join(mnmt_areas, raster_cells) %>% 
  mutate(Area = Total_Area * PropArea)  %>% 
  select(ID,  Total_Area, Code, PropArea, Area, TotalFocalArea)

mnmt_area_summary <- mnmt_areas %>% 
  ungroup() %>% 
  group_by(Code) %>% 
  mutate(TotalArea = sum(Area)) %>% 
  ungroup() %>% 
  distinct(Code, .keep_all = T) %>% 
  select(Stratum = Code, TotalArea, PropArea, TotalFocalArea) %>%
  mutate(PropArea = TotalArea/sum(TotalArea)) %>% 
  st_drop_geometry()

base_mnmt_pts <- mnmt_pts %>% 
  filter(str_detect(Panel, 'OverSample', negate = T))

# need to calculate the desired sites per stratum as function of plot weight. 
mnmt_area_summary <- mnmt_area_summary %>% 
  left_join(., deSS, by = 'Stratum') %>%  # desired ss total_area / wsAcec
  mutate(DesiredSS = round(DesiredSS * (nrow(base_mnmt_pts)/255))) %>% 
  drop_na()

mnmt_pt_draw <- mnmt_pts %>% 
  group_by(stratum, Plot.Status) %>% 
  count() %>% 
  st_drop_geometry() %>% 
  pivot_wider(id_cols = stratum, names_from = Plot.Status, values_from = n, 
              values_fill = 0) %>% 
  rowwise() %>% 
  mutate(total = sum(across(not_sampled:sampled)), .before = 'not_sampled')

mnmt_OriginalWeights <- left_join(mnmt_area_summary, mnmt_pt_draw,
                                    by = c('Stratum' = 'stratum')) %>% 
  select(Stratum, Total = total, NotSampled = not_sampled, Rejected = rejected, 
         Sampled = sampled, DesiredSS, PropArea, PropTarget, Acres =  TotalArea) %>% 
  mutate(across(.cols = Total:Sampled, ~replace_na(.x, 0))) %>% 
  mutate(ApproxStWgt =  if_else(DesiredSS >= 5, (Acres/DesiredSS) * 5, (DesiredSS/5) * Acres))

mnmt_OriginalWeights <- drop_na(mnmt_OriginalWeights)
mnmt_OriginalWeights

rm(uFO, strat_raster, p2d, lookup_table, mnmt_ptp_draw, mnmt_area_summary, 
   base_mnmt_pts, mnmt_areas, mnmtSpat, raster_cells, deSS, mnmt_pt_draw)
```


Strata with five or more plots, would allow for temporal analyses to  be conducted on their data. Strata with less than five plots can only be treated as static entities within this time period 

```{r}
plotWeigher(mnmt_OriginalWeights, mnmt_pts)
```

Under the master sample design the number of plots which could be inferred from in the Salt Desert stratum would be 17. However, due to an intensification a surplus of 5, plots were sampled, however as these plots exceed the number of ... Weird problem. 

